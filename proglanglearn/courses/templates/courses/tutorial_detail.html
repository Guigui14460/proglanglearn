{% extends 'base.html' %}
{% load static course_extras %}
{% load i18n %}

{% block title %}{{ object.title }} - {% endblock title %}

{% block extra_head %}
<link rel="stylesheet" href="{% static '/style/css/vs2015.css' %}">
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>
{% endblock extra_head %}

{% block main_attr %}class="aside"{% endblock main_attr %}

{% block aside_left %}
<aside class="navbar navbar__dark navbar__vertical">
    <div class="burger">
        <div class="line1"></div>
        <div class="line2"></div>
        <div class="line3"></div>
    </div>
    <ul class="navbar-links sticky-box">
        {% for tutorial in course_tutorials %}
            {% if object == tutorial %}
                <li class="navbar-item"><a class="active" href="{{ tutorial.get_absolute_url }}" title="{{ tutorial.title|truncatechars:25 }}">{{ forloop.counter }} - {{ tutorial.title }} </a></li>
            {% else %}
                <li class="navbar-item"><a href="{{ tutorial.get_absolute_url }}" title="{{ tutorial.title|truncatechars:25 }}">{{ forloop.counter }} - {{ tutorial.title }} </a></li>
            {% endif %}
        {% endfor %}
    </ul>
</aside>
{% endblock aside_left %}

{% block main %}
<h1 class="large">{{ object.title }}</h1>
{% if request.user.is_staff or object.author == request.user %}
    <div class="my-2 d-flex space-between">
        <a href="{% url 'courses:tutorial-update' course_slug=object.course.slug slug=object.slug %}" class="btn btn__info btn__large">Modifier le tutoriel</a>
        <a href="{% url 'courses:tutorial-delete' course_slug=object.course.slug tutorial_slug=object.slug %}" class="btn btn__danger btn__large">Supprimer le tutoriel</a>
    </div>
{% endif %}
<div class="center-text">
    {{ object.experience }}&nbsp;EXP&nbsp;|&nbsp;<i class="far fa-clock"></i>&nbsp;{{ object.content|safe|time_estimate }}&nbsp;{% trans 'minutes' %}&nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;{{ object.views }}&nbsp;|&nbsp;<a data-href="{{ object.get_favorite_api_url }}" href="{{ object.get_favorite_url }}" title="{% if tutorial_in_favorite %}Enlever des favoris{% else %}Ajouter aux favoris{% endif %}" class="favorite-span"><i class="{% if tutorial_in_favorite %}fas{% else %}far{% endif %} fa-star favorite"></i></a>
</div>
<div>
    {{ object.content|safe }}
</div>
<div class="my-2 d-flex" style="justify-content: space-around;">
    <a class="tutorial-finished-link btn btn__large btn__success" href="{{ object.get_finished_url }}"><i class="tutorial-finished-icon far {% if object in request.user.profile.tutorial_finished.all %}fa-check-square{% else %}fa-square{% endif %}"></i>&nbsp;Tutoriel terminé</a>
</div>
{% if prev_tutorial or next_tutorial %}
    <div class="d-flex space-between">
        {% if prev_tutorial %}
            <a href="{{ prev_tutorial.get_absolute_url }}" title="{{ prev_tutorial.title }}" class="btn btn__outline__success btn__large">Précédent</a>
        {% endif %}
        {% if next_tutorial %}
            {% if prev_tutorial is None %}
                <span></span>
            {% endif %}
            <a href="{{ next_tutorial.get_absolute_url }}" title="{{ next_tutorial.title }}" class="btn btn__outline__success btn__large">Suivant</a>
        {% endif %}
    </div>
{% endif %}
{% endblock main %}

{% block comments %}
<div class="comments py-2">
    {% include 'main/comments.html' %}
</div>
{% endblock comments %}

{% block javascript %}
<script src="{% static 'js/highlight.pack.js' %}"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="{% static 'js/typed.min.js' %}"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});</script>
{% endblock javascript %}

{% block jquery %}$('.reply').hide();$('.reply-btn').click(function () {$(this).parent().next().toggle();});
function ajaxComments(){
    $('.form.comment-form, .form.reply-form').submit(function(e){
        e.preventDefault();
        $.ajax({
            method: $(this).attr('method'),
            url: $(this).attr('action'),
            data: $(this).serialize(),
            dataType: 'json',
            success: function(response){
                $('.comments').html(response.html);
                $('textarea').val('');
                $('.reply').hide();$('.reply-btn').click(function () {$(this).parent().next().toggle();});
                ajaxComments();
            },
            error: function(rs, e){
                console.log(rs.responseText);
            },
        });
    });
}
ajaxComments();
$('.favorite-span').hover(function(e){
    $(this).css('cursor', 'pointer');
});
function favori(star) {
    if (star.hasClass('fas')) {
        star.parent().attr('title', "Enlever des favoris");
        $('body').append("<div class='toast'>Tutoriel ajouté aux favoris</div>");
    } else {
        star.parent().attr('title', "Mettre en favoris");
        $('body').append("<div class='toast'>Tutoriel enlevé des favoris</div>");
    }
    $('.toast').css({ 'visibility': 'visible' }).delay(3000).fadeOut('fast');
};
$('.favorite-span').click(function(e){
    e.preventDefault();
    let href = $(this).attr('href');
    let stars = [];
    $(".favorite-span").each(function(e){
        if($(this).attr('href') == href){stars.push($(this).children('.fa-star.favorite'))}
    });
    stars = $(stars);
    $.ajax({
        url: $(this).attr('href'),
        method: "GET",
        data: {favorite: 'ok'},
        success: function(data){
            stars.toggleClass('far fas');
            stars.each(function(e){favori($(this));});
        },
        error: function(error){console.log(error);}
    });
});
$('.tutorial-finished-link').click(function(e){
    e.preventDefault();
    $.ajax({
        url: $(this).attr('href'),
        method: 'GET',
        data: {finished: 'ok'},
        success: function(data){
            $('.tutorial-finished-icon').toggleClass('fa-check-square fa-square')
        },
        error: function(error){console.log(error);},
    });
});
{% endblock jquery %}
